<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobeFood - Carrinho de compras</title>
    <link rel="stylesheet" href="page-menu.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/swiper@11/swiper-bundle.min.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
</head>

<body>
    <div id="page" class="cart">
        <header>
            <div class="container">
                <nav>
                    <div class="left">
                        <div class="logo"><a href="index.html" referrerpolicy="no-referrer">.RobéFood</a></div>
                        <div class="menu">
                            <ul>
                                <li><a href="index.html" referrerpolicy="no-referrer">Home</a></li>
                                <li><a href="page-menu.html" referrerpolicy="no-referrer" target="_blank">Menu</a></li>
                                <li><a href="#">Entregas</a></li>
                                <li><a href="https://www.google.com/maps/place/Rua+26,+Luanda/@-8.9025217,13.2289012,17z/data=!3m1!4b1!4m6!3m5!1s0x1a51f45209c5efb3:0x7e0576641a24ac50!8m2!3d-8.902527!4d13.2314761!16s%2Fg%2F11fmz1tdws?entry=ttu&g_ep=EgoyMDI0MTEyNC4xIKXMDSoASAFQAw%3D%3D" referrerpolicy="no-referrer" target="_blank">Localização</a></li>
                                <li><a href="contact.html" referrerpolicy="no-referrer" target="_blank">Contato</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="right">
                        <div class="icons">
                            <a href="#" class="s-trigger">
                                <i class="ri-search-line"></i>
                                <i class="ri-close-line"></i>
                            </a>
                            <li class="cart-icon">
                                <a href="cart.html" referrerpolicy="no-referrer"  class="cart-trigger">
                                    <i class="ri-shopping-cart-line"></i>
                                    <span id="cart-count">0</span>
                                </a>
                            </li>

                            <a href="#" class="m-trigger mobile-only">
                                <i class="ri-menu-line"></i>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <form action="" class="search">
                <div class="container">
                    <input type="search" placeholder="Procure para comer...">
                </div>
            </form>
        </header>
        <main>
           <div class="single-cart">
                <div class="container">
                    <div class="wrapper">
                        <div class="breadcrumb">
                            <ul class="flexitem">
                                <li><a href="index.html" referrerpolicy="no-referrer">Home</a></li>
                                <li>Carrinho</li>
                            </ul>
                        </div>
                        <div class="page-title">
                            <h1 class="cart-title"><i class="ri-shopping-cart-line"> </i>Carrinho de compras</h1>
                        </div>
                        <div class="products one cart">
                            <div class="flexwrap">
                                <form action="" class="form-cart">
                                    <div class="item">
                                        <table id="cart-table">
                                            <thead>
                                                <tr>
                                                    <th>Ítem</th>
                                                    <th>Preço</th>
                                                    <th>Qtd</th>
                                                    <th>Subtotal</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                            </tbody>
                                        </table>
                                    </div>
                                </form>
                                <div class="cart-summary styled">
                                    <div class="item">
                                        <div class="cart-total">
                                            <table>
                                                <tbody>
                                                    <tr>
                                                        <th>Subtotal</th>
                                                        <td></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Desconto</th>
                                                        <td></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Entrega<span class="mini-text">(taxa)</span></th>
                                                        <td></td>
                                                    </tr>
                                                    <tr class="grand-total">
                                                        <th>Total</th>
                                                        <td><strong></strong></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <a class="primary-button">Finalizar Pedido</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
           </div>
        </main>
        <footer>
            <div class="container">
                <div class="wrapper">
                    <div class="widget-footer">
                        <h4>Resto</h4>
                        <ul>
                            <li><a href="#">Sobre Nós</a></li>
                            <li><a href="#">Destaques</a></li>
                            <li><a href="#">Nosso Menu</a></li>
                            <li><a href="#">Blog</a></li>
                        </ul>
                    </div>
                    <div class="widget-footer">
                        <h4>Apoio</h4>
                        <ul>
                            <li><a href="#">Centro de Apoio</a></li>
                            <li><a href="#">Feedback</a></li>
                            <li><a href="#">P e R</a></li>
                            <li><a href="#">Contate-nos</a></li>
                        </ul>
                    </div>
                    <div class="widget-footer">
                        <div class="logo"><a href="#">.RobéFood</a></div>
                        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Placeat, ipsum!</p>
                        <p>Urb. Nova vida. <br>Luanda, Angola</p>
                        <ul class="socials">
                            <li><a href="#"><i class="ri-facebook-line"></i></a></li>
                            <li><a href="#"><i class="ri-twitter-line"></i></a></li>
                            <li><a href="#"><i class="ri-instagram-line"></i></a></li>
                        </ul>
                    </div>
                </div>
                <p class="copyright">&copy 2024 .RobéBusiness &reg;.Todos os direitos reservados.</p>
            </div>
        </footer>
    </div>
    <div class="overlay"></div>
    <script>

        window.addEventListener("storage", function (e) {
        if (e.key === "cart") {
            calculateCartTotals();
        }
        }); // Chama esta função quando a página carregar
        document.addEventListener("DOMContentLoaded", updateCartCount);
        const divtoShow = "nav .menu";
        const divPopup = document.querySelector(divtoShow);
        const divTrigger = document.querySelector(".m-trigger");

        divTrigger.addEventListener("click", () => {
        setTimeout(() => {
            if (!divPopup.classList.contains("show")) {
            divPopup.classList.add("show");
            document.body.classList.add("menu-visible");
            }
        }, 250);
        });

        //---Fecha automaticamente ao clicar fora dele
        document.addEventListener("click", (e) => {
        const isClosest = e.target.closest(divtoShow);

        if (!isClosest && divPopup.classList.contains("show")) {
            divPopup.classList.remove("show");
            document.body.classList.remove("menu-visible");
        }
        });

        function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        const cartCountElement = document.getElementById("cart-count");

        if (cartCountElement) {
            cartCountElement.textContent = count;

            // Adiciona a animação
            cartCountElement.classList.add("pulse");
            setTimeout(() => {
            cartCountElement.classList.remove("pulse");
            }, 300);
        }
        }

        window.addEventListener("storage", function (e) {
        if (e.key === "cart") {
            updateCartCount();
        }
        });

        function updateCart(product, action) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const existingProductIndex = cart.findIndex(
            (item) => item.name === product.name
        );
        if (existingProductIndex !== -1) {
            if (action === "remove") {
            cart[existingProductIndex].quantity -= 1;
            if (cart[existingProductIndex].quantity <= 0) {
                cart.splice(existingProductIndex, 1);
            }
            } else if (action === "add") {
            cart[existingProductIndex].quantity += 1;
            }
        } else if (action === "add") {
            product.quantity = 1;
            cart.push(product);
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        return cart;
        }

        // Função que recebe os ítens a partir do page-menu.html e exibe os produtos dentro do corpo da tabela do cart (tbody)
        document.addEventListener("DOMContentLoaded", function () {
        const cartTableBody = document.querySelector("#cart-table tbody");
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        function renderCart() {
            cartTableBody.innerHTML = "";
            cart.forEach((product, index) => {
            const TableRow = document.createElement("tr");
            TableRow.innerHTML = `
                        <td class="flexitem">
                            <div class="thumbnail">
                                <a href="#"><img src="${product.image}" alt=""></a>
                            </div>
                            <div class="content">
                                <strong><a href="#">${product.name}</a></strong>
                            </div>
                        </td>
                        <td>${product.price}</td>
                        <td>
                            <div class="qty-control flexitem">
                                <button class="minus" data-index="${index}" aria-label="Reduce quantity">-</button>
                                <input type="text" value="${product.quantity}" min="1" name="quantity" class="quantity-input" data-index="${index}" readonly>
                                <button class="plus" data-index="${index}" aria-label="Increase quantity">+</button>
                            </div>
                        </td>
                        <td class="subtotal">${(parseFloat(product.price.replace("$", "")) * product.quantity).toFixed(2)}</td>
                        <td><a href="#" class="item-remove" data-index="${index}"><i class="ri-close-line"></i></a></td>
                    `;

            cartTableBody.appendChild(TableRow);
            });

            updateTotalPrice();
        }

        function updateTotalPrice() {
            const total = cart.reduce((sum, product) => {
            return (
                sum + parseFloat(product.price.replace("$", "")) * product.quantity
            );
            }, 0);
            document.querySelector(".total-price").textContent = `$${total.toFixed(2)}`;
        }

        function updateCart() {
            localStorage.setItem("cart", JSON.stringify(cart));
            renderCart();
            calculateCartTotals();
        }

        function removeProduct(index) {
            if (cart[index].quantity > 1) {
            cart[index].quantity--;
            } else {
            cart.splice(index, 1);
            }
            updateCart();
        }

        // Função para aumentar, diminuir a quantidade dos ítens no carrinho, e também remover ítens no carrinho  
        cartTableBody.addEventListener("click", function (e) {
            if (e.target.closest("[data-index]")) {
            const index = parseInt(e.target.closest("[data-index]").dataset.index);

            if (e.target.classList.contains("minus")) {
                removeProduct(index);
            } else if (e.target.classList.contains("plus")) {
                cart[index].quantity++;
                updateCart();
            } else if (e.target.closest(".item-remove")) {
                removeProduct(index);
            }
            }
        });

        // Observar mudanças no localStorage
        window.addEventListener("storage", function (e) {
            if (e.key === "cart") {
            cart = JSON.parse(e.newValue);
            renderCart();
            }
        });

        renderCart();
        });
        function calculateCartTotals() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const deliveryFee = 100.0; // Taxa de entrega fixa
            const discount = 10.0; // Desconto fixo

            let subtotal = 0;


        // Calcula o subtotal
        cart.forEach((item) => {
            subtotal += parseFloat(item.price.replace("$", "")) * item.quantity;
        });

        // Calcula o total
        const total = subtotal - discount + deliveryFee;

        // Atualiza o HTML com os valores calculados
        document.querySelector(
            ".cart-total tbody tr:nth-child(1) td"
        ).textContent = `$${subtotal.toFixed(2)}`;
        document.querySelector(
            ".cart-total tbody tr:nth-child(2) td"
        ).textContent = `$${discount.toFixed(2)}`;
        document.querySelector(
            ".cart-total tbody tr:nth-child(3) td"
        ).textContent = `$${deliveryFee.toFixed(2)}`;
        document.querySelector(
            ".cart-total tbody tr.grand-total td strong"
        ).textContent = `$${total.toFixed(2)}`;
        }

        // Chama a função quando a página carregar
        document.addEventListener("DOMContentLoaded", calculateCartTotals);
        document.addEventListener("DOMContentLoaded", function () {

            // atualiza os preços em tempo real
            const quantityInputs = document.querySelectorAll(".quantity-input");
            quantityInputs.forEach((input) => {
                input.addEventListener("change", updateItemPrice);
            });

            function updateItemPrice(event) {
                const input = event.target;
                const quantity = parseInt(input.value);
                const itemRow = input.closest("tr");
                const pricePerItem = parseFloat(
                itemRow.querySelector(".price").textContent.replace("$", "")
                );
                const totalPriceElement = itemRow.querySelector(".total-price");

                const totalPrice = quantity * pricePerItem;
                totalPriceElement.textContent = "$" + totalPrice.toFixed(2);

                updateCartTotal();
            }

            function updateCartTotal() {
                const totalPrices = document.querySelectorAll(".total-price");
                let cartTotal = 0;
                totalPrices.forEach((price) => {
                cartTotal += parseFloat(price.textContent.replace("$", ""));
                });
                document.getElementById("cart-total").textContent =
                "$" + cartTotal.toFixed(2);
            }
        });
    </script>
</body>
</html>